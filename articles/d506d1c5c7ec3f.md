---
title: "logrotateã§mysqlã®å®šæœŸãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ç°¡å˜è‡ªå‹•åŒ–ï¼"
emoji: "ðŸ’¬"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["mysql", "linux"]
published: true
---
ã“ã‚“ã«ã¡ã¯ãƒ¼ï¼ã‚€ã¡ã‚‡ã“ã§ã™ã€‚
mysql ã®è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®šã‚’ã™ã‚‹æ©Ÿä¼šãŒã‚ã£ãŸã®ã§ã€æ–¹æ³•ã‚’ã“ã“ã«è¨˜éŒ²ã—ã¦ãŠãã¾ã™ã€‚

ã“ã“ã§ã¯ `logrotate` ã‹ã‚‰ `mysqldump` ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€æ¯Žæ—¥ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆã¨å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤ã‚’è‡ªå‹•åŒ–ã—ã¦ã„ã¾ã™ã€‚

# æ‰‹é †

## 1. mysql ã®å°‚ç”¨ãƒ¦ãƒ¼ã‚¶ã‚’ä½œæˆã™ã‚‹

æ„å›³ã›ã¬æ“ä½œã‚’äºˆã‚é˜²æ­¢ã™ã‚‹ãŸã‚ã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å°‚ç”¨ãƒ¦ãƒ¼ã‚¶ã‚’ä½œæˆã—ã¾ã™ã€‚

### æ–°è¦ãƒ¦ãƒ¼ã‚¶ã®ä½œæˆ

ä»Šå›žã¯ `mysql` ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‚µãƒ¼ãƒã¨ `logrotate` ã‚’å®Ÿè¡Œã—ãŸã„ã‚µãƒ¼ãƒãŒåŒã˜ãªã®ã§ã€ãƒ›ã‚¹ãƒˆã«ã¯ `localhost` ã‚’æŒ‡å®šã—ã¾ã—ãŸã€‚é•ã†ã‚µãƒ¼ãƒã®å ´åˆã¯é©å®œå¤‰æ›´ã—ã¦ãã ã•ã„ã€‚

```
CREATE USER `{your_name}`@`localhost` IDENTIFIED BY {your_password};
```


### å¯¾è±¡ãƒ†ãƒ¼ãƒ–ãƒ«ã«æœ€ä½Žé™ã®æ¨©é™ã ã‘ã‚’ä»˜ä¸Ž

ä½œæˆã—ãŸãƒ¦ãƒ¼ã‚¶ã«å¯¾ã—ã¦ `mysqldump` ã®å®Ÿè¡Œã«å¿…è¦ãª `SELECT` ã¨ `LOCK TABLES` ã®æ¨©é™ã‚’ä»˜ä¸Žã—ã¾ã™ã€‚

```
GRANT SELECT, LOCK TABLES ON {your_database}.* to `{your_name}`;
```

## 2. logrotateã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹

`logrotate.d` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä¸­ã«ã€é©å½“ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
ã“ã“ã§ã¯ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ `mysqldump`  ã¨ã—ã¾ã—ãŸã€‚åˆ†ã‹ã‚Šã‚„ã™ã„åå‰ãªã‚‰ãªã‚“ã§ã‚‚è‰¯ã„ã§ã™ã€‚
ã¾ãŸã€ä¿å­˜å…ˆã‚’`/var/log/dump.sql` ã«ã—ã¾ã—ãŸã€‚ã“ã‚Œã‚‚ãŠå¥½ããªå ´æ‰€ã«å¤‰æ›´å¯èƒ½ã§ã™ã€‚

```
# vim /etc/logrotate.d/mysqldump

/var/log/dump.sql.gz {
        daily
        rotate 7
        size 0
        missingok
        nocompress
        postrotate
                mysqldump -u{your_name} -p{your_password} {your_database} | gzip > /var/log/dump.sql.gz
        endscript
}
```

### è¨­å®šå†…å®¹ã®è©³ç´°

ä¸Šè¨˜ã§è¨­å®šã—ãŸå†…å®¹ã®æ„å‘³ã¯ã€ä»¥ä¸‹ã®ã‚³ãƒ¡ãƒ³ãƒˆã®é€šã‚Šã§ã™ã€‚

```
/var/log/dump.sql.gz {  # /var/log/dump.sql.gz ã‚’ãƒ­ãƒ¼ãƒ†ãƒ¼ãƒˆã™ã‚‹
        daily           # æ¯Žæ—¥ãƒ­ãƒ¼ãƒ†ãƒ¼ãƒˆã‚’å®Ÿè¡Œã™ã‚‹
        rotate 7        # 7ä¸–ä»£åˆ†ã®ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ®‹ã™
        size 0          # æ›´æ–°ä¸­ã®ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒ 0byte ã‚’è¶…ãˆãŸã¨ãã«ãƒ­ãƒ¼ãƒ†ãƒ¼ãƒˆã™ã‚‹
        missingok       # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªãã¦ã‚‚ã‚¨ãƒ©ãƒ¼ã‚’å‡ºåŠ›ã—ãªã„
        nocompress      # ãƒ­ãƒ¼ãƒ†ãƒ¼ãƒˆæ™‚ã«åœ§ç¸®ã—ãªã„
        postrotate      # ã“ã“ã‹ã‚‰ endscript ã¾ã§ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒ­ãƒ¼ãƒ†ãƒ¼ãƒˆå¾Œã«å®Ÿè¡Œã™ã‚‹
                mysqldump -u{your_name} -p{your_password} {your_database} | gzip > /var/log/dump.sql.qz # ä½œæˆã—ãŸãƒ¦ãƒ¼ã‚¶ã§ `mysqldump` ã‚³ãƒžãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€çµæžœã‚’ gzip ã§åœ§ç¸®ã—ã¦å‡ºåŠ›ã™ã‚‹
        endscript
}
```

## 3. æ‰‹å‹•å®Ÿè¡Œ

ã‚¨ãƒ©ãƒ¼ãªããƒ­ãƒ¼ãƒ†ãƒ¼ãƒˆã•ã‚Œã‚‹ã‹æ‰‹å‹•å®Ÿè¡Œã—ã¦ç¢ºèªã—ã¦ã„ãã¾ã™ã€‚
ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„ã¨ãƒ­ãƒ¼ãƒ†ãƒ¼ãƒˆã®ã—ã‚ˆã†ãŒãªã„ã®ã§ã€åˆå›žã¯ç©ºã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚Šã¾ã™ã€‚

```
# touch /var/log/dump.sql
# gzip /var/log/dump.sql
```

è©³ç´°è¡¨ç¤ºã® `v` ã¨å¼·åˆ¶ãƒ­ãƒ¼ãƒ†ãƒ¼ãƒˆã® `f` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ã¦å®Ÿè¡Œã—ã¾ã™ã€‚
```
# /usr/sbin/logrotate -vf /etc/logrotate.d/mysqldump
```

ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã‚‰ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚
ç©ºãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ­ãƒ¼ãƒ†ãƒ¼ãƒˆã•ã‚Œã€æ–°ã—ã„ dump ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

```
-rw-r--r--   1 root   root    192972 Dec  7 12:26 dump.sql.gz
-rw-r--r--   1 root   root        35 Dec  7 12:26 dump.sql.gz.1
```

## 4. è‡ªå‹•å®Ÿè¡Œçµæžœç¢ºèª

ç¿Œæ—¥ä»¥é™ã«ä»¥ä¸‹ãŒç¢ºèªã§ãã‚Œã°è¨­å®šå®Œäº†ã§ã™ã€‚
* è‡ªå‹•ã§ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹
* å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ­ãƒ¼ãƒ†ãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹

# ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

ã†ã¾ãè¡Œã‹ãªã„ã¨ãã¯æ¬¡ã®é …ç›®ã‚’ç¢ºèªã—ã¦ã„ãã¾ã™ã€‚

## å®Ÿè¡Œãƒ­ã‚°ã®ç¢ºèª

å®Ÿè¡Œã•ã‚ŒãŸæ—¥ä»˜ã‚’ç¢ºèªã—ã¾ã™ã€‚

```
# cat /var/lib/logrotate/logrotate.status
```

`logrotate.status` ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å ´æ‰€ã¯ç’°å¢ƒã«ã‚ˆã£ã¦ç•°ãªã‚Šã¾ã™ã€‚`# man logrotate` ã®å®Ÿè¡Œã§ç¢ºèªã§ãã¾ã™ã€‚

## æ‰‹å‹•å®Ÿè¡Œ

å®Ÿè¡Œã‚¨ãƒ©ãƒ¼ãŒå‡ºãªã„ã‹ç¢ºèªã—ã¾ã™ã€‚

```
# /usr/sbin/logrotate -vf /etc/logrotate.d/mysqldump
```

## ã‚¹ã‚¯ãƒªãƒ—ãƒˆã ã‘å®Ÿè¡Œ

postrotate ï½ž endscript ã®é–“ã«æ›¸ã„ãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒæ­£å¸¸ã«å‹•ãã®ã‹ç¢ºèªã—ã¾ã™ã€‚

```
# mysqldump -u{your_name} -p{your_password} {your_database} | gzip > /var/log/dump.sql.qz
```
